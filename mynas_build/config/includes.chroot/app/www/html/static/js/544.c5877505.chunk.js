"use strict";(self.webpackChunkmypxe_admin=self.webpackChunkmypxe_admin||[]).push([[544,8,569,425],{89008:function(t,e,n){n.r(e);var a=n(37762),r=n(93433),u=n(1413),o=n(29439),s=n(47313),c=n(51629),i=n(70501),l=n(66835),d=n(23477),f=n(24076),p=n(67478),h=n(57861),m=n(69099),v=n(99783),x=n(37982),_=n(46417);e.default=function(t){var e=(0,x.useData)(),n=e.global_data,b=(e.api,(0,s.useState)([])),Z=(0,o.Z)(b,2),w=Z[0],g=(Z[1],(0,s.useState)(!0)),j=(0,o.Z)(g,2),k=(j[0],j[1],(0,s.useState)(0)),y=(0,o.Z)(k,2),C=y[0],S=y[1],D=(0,s.useState)(10),N=(0,o.Z)(D,2),T=N[0],R=N[1],E=(0,s.useState)({online:!1,status_text:"\u79bb\u7ebf"}),I=(0,o.Z)(E,2),O=(I[0],I[1],(0,s.useState)({data:[],disks:t.data||[]})),F=(0,o.Z)(O,2),W=F[0],A=F[1],P=function(t){A((function(e){return(0,u.Z)((0,u.Z)({},e),t)}))},z=(0,s.useState)(""),J=(0,o.Z)(z,2),M=J[0],$=(J[1],W.disks.filter((function(t){return Object.values(t).some((function(t){return t.toString().toLowerCase().includes(M.toLowerCase())}))})));return(0,s.useEffect)((function(){P({disks:t.data});n.get("blockdevices");var e=function(e){var o,s=n.get("blockdevices"),c=w,i=(0,r.Z)(W.disks),l=(0,a.Z)(t.data);try{var d=function(){var t=o.value,e=i.findIndex((function(e){return e.path==t.path}));e<0&&i.push(t)};for(l.s();!(o=l.n()).done;)d()}catch(p){l.e(p)}finally{l.f()}var f=e;c.forEach((function(t){var e=f.filter((function(e){return t.path=="/dev/".concat(e.Device)}))[0];if(s){var n=s.filter((function(e){return e.path===t.path}))[0];if(e&&n){var a=i.findIndex((function(e){return e.path==t.path}));a>=0?i.splice(a,1,(0,u.Z)((0,u.Z)({},n),{},{id:t.path},e)):i.push((0,u.Z)((0,u.Z)({},n),{},{id:t.path},e))}}})),P({disks:(0,r.Z)(i)})};return n.watch("sysstat",e),function(){n.unwatch("sysstat",e)}}),[t.data]),(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(c.Z,{component:i.Z,children:(0,_.jsxs)(l.Z,{children:[(0,_.jsx)(d.Z,{children:(0,_.jsxs)(f.Z,{children:[(0,_.jsx)(p.Z,{children:"\u8bbe\u5907"}),(0,_.jsx)(p.Z,{children:"PATH"}),(0,_.jsx)(p.Z,{children:"\u6807\u8bc6"}),(0,_.jsx)(p.Z,{children:"\u5bb9\u91cf"}),(0,_.jsx)(p.Z,{children:"\u8bfb\u53d6"}),(0,_.jsx)(p.Z,{children:"\u5199\u5165"})]})}),(0,_.jsx)(h.Z,{children:$.slice(C*T,C*T+T).map((function(e){return(0,_.jsxs)(f.Z,{children:[(0,_.jsxs)(p.Z,{children:[t.onDown&&(0,_.jsx)(m.Z,{onClick:function(){return t.onDown(e)},children:"\u4e0b\u7ebf"}),t.onAdd&&t.check_add_status&&t.check_add_status(e)&&(0,_.jsx)(m.Z,{onClick:function(){return t.onAdd(e)},children:"\u6dfb\u52a0\u5230\u6c60"}),t.onRemove&&(0,_.jsx)(m.Z,{onClick:function(){return t.onRemove(e)},children:"\u79fb\u9664"})]}),(0,_.jsx)(p.Z,{children:e.path}),(0,_.jsxs)(p.Z,{children:[e.model," ",e.serial," ",e.size]}),(0,_.jsx)(p.Z,{children:e.size}),(0,_.jsx)(p.Z,{children:e["kB_read/s"]}),(0,_.jsx)(p.Z,{children:e["kB_wrtn/s"]})]},e.path)}))})]})}),(0,_.jsx)(v.Z,{component:"div",count:$.length,page:C,onPageChange:function(t,e){S(e)},rowsPerPage:T,onRowsPerPageChange:function(t){R(parseInt(t.target.value,10)),S(0)},style:{marginTop:"1rem"}})]})}},9569:function(t,e,n){n.r(e);var a=n(74165),r=n(15861),u=n(29439),o=n(47313),s=n(69099),c=n(71889),i=n(37982),l=n(89008),d=n(46417);e.default=function(t){var e=t.data;console.log("pool=",e);var n=(0,i.useData)(),f=n.global_data,p=n.api,h=(0,o.useState)([]),m=(0,u.Z)(h,2),v=m[0],x=m[1];(0,o.useEffect)((function(){x(t.data.label)}),[t.data]);var _=function(){var t=(0,r.Z)((0,a.Z)().mark((function t(n){var r,u;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.run_command(c.default.device.evacuate({device:n.path,mount_path:e.mount_path}));case 2:if(0!=t.sent.ret){t.next=17;break}return t.next=6,p.run_command(c.default.device.remove({device:n.path,mount_path:e.mount_path}));case 6:if(0!=t.sent.ret){t.next=17;break}return(r=e.label.findIndex((function(t){return t.path==n.path})))>=0&&e.label.splice(r,1),u=f.get("pools"),(r=u.findIndex((function(t){return t.name===e.name})))>=0&&u.splice(r,1,e),t.next=15,p.config_file({filename:"config/pools.config",op:"put",data:JSON.stringify(u)});case 15:0==t.sent.ret&&(x(e.label),f.set("pools",u));case 17:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),b=function(){var t=(0,o.useState)({online:!1,status_text:"\u79bb\u7ebf"}),n=(0,u.Z)(t,2),i=n[0],l=n[1],f=function(){var t=(0,r.Z)((0,a.Z)().mark((function t(){var n,r;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.mount_path,t.next=3,p.run_command(c.default.fs.usage(n));case 3:0==(r=t.sent).ret?(r.data.stdout.split("\n"),l({online:!0,status_text:"\u5728\u7ebf"})):l({online:!1,status_text:"\u79bb\u7ebf"});case 5:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),h=function(){var t=(0,r.Z)((0,a.Z)().mark((function t(n){return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.preventDefault(),t.next=3,p.run_command(c.default.mount(e));case 3:return t.sent,t.next=6,f();case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),m=function(){var t=(0,r.Z)((0,a.Z)().mark((function t(n){return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.preventDefault(),t.next=3,p.run_command(c.default.umount(e));case 3:return t.sent,t.next=6,f();case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();return(0,o.useEffect)((function(){var t=setInterval((function(){f()}),6e4);return f(),function(){clearInterval(t)}}),[]),(0,d.jsxs)("div",{children:["\u540d\u79f0:",e.name," \u6302\u8f7d\u4f4d\u7f6e: ",e.mount_path," \u72b6\u6001:",i.online&&(0,d.jsx)(s.Z,{onClick:m,children:"\u5378\u8f7d"}),!i.online&&(0,d.jsx)(s.Z,{onClick:h,children:"\u6302\u8f7d"})]})};return(0,d.jsxs)("div",{children:[(0,d.jsx)(b,{}),(0,d.jsx)(l.default,{data:v,onDown:function(t){console.log("down==",t)},onRemove:_}),";"]})}},32544:function(t,e,n){n.r(e);var a=n(93433),r=n(37762),u=n(29439),o=n(74165),s=n(15861),c=n(1413),i=n(47313),l=n(95162),d=n(65489),f=(n(43772),n(47425),n(63469)),p=n(63705),h=n(47610),m=n(86385),v=n(56659),x=n(69393),_=n(84724),b=n(37982),Z=(n(89008),n(9569),n(46817)),w=n(71889),g=n(55293),j=n(94536),k=n(46417),y=b.context_value.global_data,C=b.context_value.api,S=(b.context_value.make_watch_data,function(t){var e=(0,x.useWindowManager)(),n=(e.windows,e.getApps,e.openWindow,e.set_window_ref,e.openDialog,e.closeDialog),a=(0,i.useRef)(null),r=(0,c.Z)((0,c.Z)({},_.default),{},{$ref:"#/definitions/".concat(t.schema)}),u=(0,i.useContext)(b.DataContext),l=(u.global_data,u.api,t.data),d=(0,c.Z)({},l),f=function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){var r;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.current.getValue(),"balance"==t.type){e.next=7;break}if(""==r.device){e.next=7;break}return e.next=5,t.onSave(r);case 5:if(!e.sent){e.next=7;break}n(t.id);case 7:return e.next=9,t.onSave(r);case 9:if(!e.sent){e.next=11;break}n(t.id);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return"replace"==t.type&&"\u66ff\u6362\u786c\u76d8",(0,k.jsxs)(p.default,{id:t.id,children:[(0,k.jsx)("div",{type:"title"}),(0,k.jsx)("div",{type:"content",children:(0,k.jsx)(Z.default,{schema:r,ref:a,data:d})}),(0,k.jsx)("button",{type:"action",className:"button warning",onClick:f,children:"\u786e\u5b9a"}),(0,k.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u53d6\u6d88"})]})}),D={btrfs:{command:"btrfs",args:["filesystem","show"],Rend:function(t){var e=t.data,n=(0,b.rix_make_watch_data)((0,c.Z)((0,c.Z)({},e),{},{status:"ok",info:""})),a=(0,b.useData)(),r=a.global_data,l=a.api,d=(r.disks_health,r.pools||[]),w=d.findIndex((function(t){return t.uuid==e.uuid}));w>=0&&n.set("name",d[w].name);var y=function(){g.default.info(n.mount_path).then(function(){var t=(0,s.Z)((0,o.Z)().mark((function t(e){var a,u,s,i,l,d,f;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=19;break}if(u=null!==(a=null===n||void 0===n?void 0:n.devices)&&void 0!==a?a:[],s=e,(i=u.filter((function(t){return s.devices.findIndex((function(e){return e.path==t.path}))<0}))).length>0&&j.default.update_blockdevice(i,null),!((l=r.pools.findIndex((function(t){return t.uuid==n.uuid})))>=0)){t.next=16;break}return d=r.pools[l],console.log("ready get info==",n),t.next=11,g.default.info(n.mount_path);case 11:f=t.sent,console.log("old_pool data=",d,"newinfo==",f),r.pools.splice(l,1,(0,c.Z)((0,c.Z)({},d),f)),r.update("pools"),n.set("name",d.name);case 16:n.set("devices",e.devices),t.next=20;break;case 19:n.set("devices",null);case 20:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},C=function t(){var e=setTimeout((0,s.Z)((0,o.Z)().mark((function a(){var r;return(0,o.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return clearTimeout(e),a.next=3,l.run_command(g.default.balance.status({mount_path:n.mount_path}));case 3:if(!((r=a.sent).ret>=0)){a.next=13;break}if(!(r.data.stdout.indexOf("No balance")>=0)){a.next=12;break}return n.set("status","ok"),n.set("info",""),y(),a.abrupt("return");case 12:n.set("info",r.data.stdout);case 13:t();case 14:case"end":return a.stop()}}),a)}))),1e4);n.set("balance_timer",e)},D=function t(){var e=setTimeout((0,s.Z)((0,o.Z)().mark((function a(){var r;return(0,o.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return clearTimeout(e),a.next=3,l.run_command(g.default.device.replace.status({mount_path:n.mount_path}));case 3:if(!((r=a.sent).ret>=0)){a.next=13;break}if(!(r.data.stdout.indexOf("finished on")>=0)){a.next=12;break}return n.set("status","ok"),n.set("info",""),y(),a.abrupt("return");case 12:n.set("info",r.data.stdout);case 13:t();case 14:case"end":return a.stop()}}),a)}))),1e3);n.set("replace_timer",e)},N=function t(){var e=setTimeout((0,s.Z)((0,o.Z)().mark((function a(){var r;return(0,o.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return clearTimeout(e),a.next=3,l.run_command(g.default.device.remove_status({mount_path:n.mount_path}));case 3:if(!((r=a.sent).ret>=0)){a.next=13;break}if(""!=r.data.stdout.trim()){a.next=12;break}return n.set("status","ok"),n.set("info",""),y(),a.abrupt("return");case 12:n.set("info",r.data.stdout);case 13:t();case 14:case"end":return a.stop()}}),a)}))),1e3);n.set("remove_timer",e)};(0,i.useEffect)((function(){y(),l.run_command(g.default.balance.status({mount_path:n.mount_path})).then((function(t){t.ret>=0&&t.data.stdout.indexOf("running")>=0&&(C(),n.set("info",t.data.stdout),n.set("status","balance"))})),l.run_command(g.default.device.replace.status({mount_path:n.mount_path})).then((function(t){t.ret>=0&&t.data.stdout.indexOf("% done")>=0&&(D(),n.set("info",t.data.stdout),n.set("status","replacing"))})),l.run_command(g.default.device.remove_status({mount_path:n.mount_path})).then((function(t){t.ret>=0&&""!=t.data.stdout.trim()&&(N(),n.set("info",t.data.stdout),n.set("status","remove"))}));var t=r.watch("pools",(function(){var t=r.pools.filter((function(t){return t.uuid==n.uuid}))[0];t&&(n.name!=t.name&&n.set("name",t.name),n.mount_path!=t.mount_path&&n.set("mount_path",t.mount_path))}));return function(){n.balance_timer&&(clearTimeout(n.balance_timer),n.set("balance_timer",null)),n.replace_timer&&(clearTimeout(n.replace_timer),n.set("replace_timer",null)),n.remove_timer&&(clearTimeout(n.remove_timer),n.set("remove_timer",null)),r.unwatch("pools",t)}}));var T=function(){var t=(0,i.useState)(0),a=(0,u.Z)(t,2),d=(a[0],a[1],(0,x.useWindowManager)()),b=(d.windows,d.getApps,d.openWindow,d.set_window_ref,d.openDialog),w=d.closeDialog,T=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];(0,i.useEffect)((function(){var t=n.watch("name",(function(){r(a+1)})),e=n.watch("devices",(function(){r(a+1)}));return function(){n.unwatch("name",t),n.unwatch("devices",e)}}));var o="";return o=n.name?"".concat(n.name," \u6302\u8f7d\u4f4d\u7f6e:").concat(n.mount_path):"\u6302\u8f7d\u4f4d\u7f6e:".concat(n.mount_path," \u5206\u533a\u7c7b\u578b:").concat(n.type),n.devices||(o+="\uff08\u672a\u6302\u8f7d\uff09"),o},R=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(e,a){var r,u;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=a.row,u="#/bin/bash\nnohup btrfs device remove ".concat(r.devid," ").concat(n.mount_path," &> /dev/null &\n"),t.next=4,l.config_file({filename:"/tmp/device_remove.sh",op:"put",data:u});case 4:if(0!=t.sent.ret){t.next=10;break}return t.next=8,l.run_command({command:"bash",args:["/tmp/device_remove.sh"]});case 8:0==t.sent.ret&&(n.set("status","remove"),N());case 10:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),E=function(t){var e=t.row;return j.default.RendHealth(e)},I=function(t){var e=t.row;return j.default.RendStats(e)},O=function(t){var e=t.row,a=(0,i.useState)(0),r=(0,u.Z)(a,2),o=r[0],s=r[1];return(0,i.useEffect)((function(){var t=n.watch("status",(function(){s(o+1)}));return function(){n.unwatch("status",t)}})),"ok"!=n.status?(0,k.jsx)(k.Fragment,{}):n.devices.length>1?(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)(f.default,{className:"button success",onClick:function(t){return R(t,{row:e})},children:"\u79fb\u9664"}),(0,k.jsx)(f.default,{className:"button success",onClick:function(t){return $(t,{row:e})},children:"\u66ff\u6362"})]}):(0,k.jsx)(k.Fragment,{})},F=function(t){var e,a,u,o,s,d,f=(0,i.useRef)(null),h=t.data,m={type:null!==(e=h.type)&&void 0!==e?e:"btrfs",mount_path:null!==(a=null===h||void 0===h?void 0:h.mount_path)&&void 0!==a?a:"",mount_option:null!==(u=null===h||void 0===h?void 0:h.mount_option)&&void 0!==u?u:"",name:null!==(o=null===h||void 0===h?void 0:h.name)&&void 0!==o?o:"",uuid:null!==(s=null===h||void 0===h?void 0:h.uuid)&&void 0!==s?s:"",auto_mount:null!==(d=null===h||void 0===h?void 0:h.auto_mount)&&void 0!==d&&d},v=(0,c.Z)((0,c.Z)({},_.default),{},{$ref:"#/definitions/".concat(t.schema)});return"modify_pool"==t.schema&&"\u4fee\u6539\u5b58\u50a8\u6c60",(0,k.jsxs)(p.default,{id:t.id,children:[(0,k.jsx)("div",{type:"title",children:(0,k.jsx)(T,{})}),(0,k.jsx)("div",{type:"content",children:(0,k.jsx)(Z.default,{schema:v,ref:f,data:m})}),(0,k.jsx)("button",{type:"action",className:"button primary",onClick:function(){var e=f.current.getValue(),a=r.pools||[],u=a.findIndex((function(t){return t.uuid==e.uuid}));u>=0?a.splice(u,1,e):a.push(e),n.set("name",e.name),n.set("mount_path",e.mount_path),r.set("pools",a),l.config_file({filename:"/app/config/pools.config",op:"put",data:JSON.stringify(a)}).then((function(e){0==e.ret&&w(t.id)}))},children:"\u4fdd\u5b58"}),(0,k.jsx)("button",{type:"action",className:"button js-dialog-close",onClick:function(){},children:"\u53d6\u6d88"})]})},W=function(){var t="dialog_"+Date.now();b({id:t,content:(0,k.jsx)(F,{data:e,schema:"add_to_pool",id:t})})},A=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(e){return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.run_command(g.default.device.add({device:e.device,mount_path:e.mount_path}));case 2:if(0!=t.sent.ret){t.next=6;break}return y(),t.abrupt("return",!0);case 6:return t.abrupt("return",!1);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),P=function(){var t="dialog_"+Date.now(),e={uuid:n.uuid,mount_path:n.mount_path};b({id:t,content:(0,k.jsx)(S,{data:e,schema:"pool_add_device",id:t,onSave:A})})},z=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(e){return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.run_command(g.default.balance.start({mount_path:n.mount_path,data_convert:e.data_convert}));case 2:if(0!=t.sent.ret){t.next=7;break}return n.set("status","balance"),C(),t.abrupt("return",!0);case 7:return t.abrupt("return",!1);case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),J=function(){var t="dialog_"+Date.now(),e={uuid:n.uuid,mount_path:n.mount_path};b({id:t,content:(0,k.jsx)(S,{data:e,schema:"btrfs_balance",id:t,onSave:z,type:"balance"})})},M=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(e){var a;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(""!=e.target_device){t.next=2;break}return t.abrupt("return",!1);case 2:if(null!=(a=n.devices.filter((function(t){return t.path==e.device}))[0])){t.next=5;break}return t.abrupt("return",!1);case 5:return t.next=7,l.run_command(g.default.device.replace.start({device:a.devid,target_device:e.target_device,mount_path:e.mount_path}));case 7:if(0!=t.sent.ret){t.next=12;break}return n.set("status","replacing"),D(),t.abrupt("return",!0);case 12:return t.abrupt("return",!1);case 13:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),$=function(t,e){var a=e.row,r="dialog_"+Date.now(),u={uuid:n.uuid,mount_path:n.mount_path,device:a.path};b({id:r,content:(0,k.jsx)(S,{data:u,schema:"pool_replace_device",id:r,onSave:M})})},V=function(){return(r.pools||[]).findIndex((function(t){return t.uuid==e.uuid}))>=0?(0,k.jsx)(k.Fragment,{}):(0,k.jsx)(f.default,{className:"button success",onClick:W,children:"\u6ce8\u518c"})},B=function(){var t=r.pools||[],n=t.findIndex((function(t){return t.uuid==e.uuid}));if(n>=0){return(0,k.jsx)(f.default,{className:"button success",onClick:function(){!function(t){var e="dialog_"+Date.now();b({id:e,content:(0,k.jsx)(F,{data:t,schema:"modify_pool",id:e})})}(t[n])},children:"\u4fee\u6539"})}return(0,k.jsx)(k.Fragment,{})},H=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];return(0,i.useEffect)((function(){var t=n.watch("status",(function(){r(a+1)}));n.watch("devices",(function(){r(a+1)}));return function(){n.unwatch("status",t),n.unwatch("devices",t)}})),n.devices&&"ok"==n.status?(0,k.jsx)(f.default,{className:"button success",onClick:J,children:"\u5747\u8861"}):(0,k.jsx)(k.Fragment,{})},L=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];return(0,i.useEffect)((function(){var t=n.watch("status",(function(){r(a+1)}));n.watch("devices",(function(){r(a+1)}));return function(){n.unwatch("state",t),n.unwatch("devices",t)}})),n.devices&&"ok"==n.status?(0,k.jsx)(f.default,{className:"button success",onClick:P,children:"\u6dfb\u52a0"}):(0,k.jsx)(k.Fragment,{})},Y=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];return(0,i.useEffect)((function(){var t=n.watch("info",(function(){r(a+1)}));return function(){n.unwatch("info",t)}})),n.info&&""!=n.info?(0,k.jsx)("span",{children:n.info}):(0,k.jsx)(k.Fragment,{})},q=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(){var e;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,g.default.umount(n);case 2:0==(e=t.sent).ret?(n.set("devices",null),n.set("state","unmount"),y()):n.set("info",JSON.stringify(e));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),G=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(){var e;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,g.default.mount(n);case 2:0==(e=t.sent).ret?(n.set("state","ok"),y()):n.set("info",JSON.stringify(e));case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),K=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];return(0,i.useEffect)((function(){var t=n.watch("status",(function(){r(a+1)}));n.watch("devices",(function(){r(a+1)}));return function(){n.unwatch("status",t),n.unwatch("devices",t)}})),"ok"==n.status?n.devices?(0,k.jsx)(f.default,{className:"button success",onClick:q,children:"\u5378\u8f7d"}):(0,k.jsx)(f.default,{className:"button success",onClick:G,children:"\u6302\u8f7d"}):(0,k.jsx)(k.Fragment,{})},Q=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),a=e[0],r=e[1];return(0,i.useEffect)((function(){var t=n.watch("devices",(function(){r(a+1)}));return function(){n.unwatch("devices",t)}})),n.devices?(0,k.jsxs)(m.default,{data:n.devices,children:[(0,k.jsx)(m.default.TableColumn,{label:"devid",prop:"devid"}),(0,k.jsx)(m.default.TableColumn,{label:"path",prop:"path"}),(0,k.jsx)(m.default.TableColumn,{label:"\u5df2\u7528",prop:"used"}),(0,k.jsx)(m.default.TableColumn,{label:"size",prop:"size"}),(0,k.jsx)(m.default.TableColumn,{label:"\u5065\u5eb7\u5ea6(\u5df2\u6d88\u8017)",children:(0,k.jsx)(v.default,{"slot-scope":"{row}",children:(0,k.jsx)(E,{})})}),(0,k.jsx)(m.default.TableColumn,{label:"\u8bfb/\u5199\u901f\u5ea6",children:(0,k.jsx)(v.default,{"slot-scope":"{row}",children:(0,k.jsx)(I,{})})}),(0,k.jsxs)(m.default.TableColumn,{label:"\u7f16\u8f91",children:[(0,k.jsx)(v.default,{slot:"header","slot-scope":"scope"}),(0,k.jsx)(v.default,{"slot-scope":"{row}",children:(0,k.jsx)(O,{})})]})]}):(0,k.jsx)("div",{children:"\u672a\u6302\u8f7d"})},U=function(){return(0,k.jsxs)(h.default,{collapsible:!0,children:[(0,k.jsx)(T,{type:"title"}),(0,k.jsx)("div",{type:"icon",class:"mif-apps"}),(0,k.jsx)(V,{type:"button"}),(0,k.jsx)(K,{type:"button"}),(0,k.jsx)(L,{type:"button"}),(0,k.jsx)(B,{type:"button"}),(0,k.jsx)(H,{type:"button"}),(0,k.jsx)(Y,{}),(0,k.jsx)(Q,{})]})};return(0,k.jsx)(U,{})};return(0,k.jsx)(T,{})}},bcachefs:{command:"bcachefs",args:["fs","usage","-h"],Rend:function(t){var e=t.data;return(0,k.jsx)(w.default.Render,{data:e})}}},N=function(t){var e=(0,i.useRef)(null),n=(0,c.Z)((0,c.Z)({},_.default),{},{$ref:"#/definitions/add_pool"}),a=(0,x.useWindowManager)().closeDialog;return(0,k.jsxs)(p.default,{id:t.id,children:[(0,k.jsx)("div",{type:"title",children:"\u6dfb\u52a0\u5b58\u50a8\u6c60"}),(0,k.jsx)("div",{type:"content",children:(0,k.jsx)(Z.default,{schema:n,ref:e,data:{}})}),(0,k.jsx)("button",{type:"action",className:"button",onClick:function(){var n=e.current.getValue(),r=y.pools||[];n.uuid=(0,l.Z)(),r.push(n),console.log("pools=",r),y.set("pools",r),C.config_file({filename:"/app/config/pools.config",op:"put",data:JSON.stringify(r)}).then((function(e){0==e.ret&&a(t.id)}))},children:"\u786e\u5b9a"}),(0,k.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u53d6\u6d88"})]})},T=(0,i.forwardRef)((function(t,e){var n=(0,b.useData)(),l=n.global_data,p=n.api,h=(0,x.useWindowManager)(),m=(h.windows,h.getApps,h.openWindow,h.set_window_ref,h.openDialog),v=(h.closeDialog,(0,b.rix_make_watch_data)({disks:[],drawOpen:!1,all_disk:!0,show_pools:!1,openAddDialog:!1,schema:{},scan_pool_list:[],update:0,data:{id:0,key:"",status:0,type:0,value:"",parent_id:0}})),_=function(t){for(var e in t)v.set(e,t[e])};(0,i.useEffect)((function(){var t=function(t){_({disks:t})};return l.watch("blockdevices",t),function(){l.unwatch("blockdevices",t)}}),[]);var Z=function(){var t=(0,s.Z)((0,o.Z)().mark((function t(){var e,n,a,u,s,i,d,f;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.run_command({command:"mount",args:[]});case 2:if(e=t.sent,n=function(t){var e=t.match(/\(([^)]+)\)/);return e?e[1]:null},0!=e.ret){t.next=28;break}a=e.data.stdout.split("\n").map((function(t){var e=t.split(/\s+/);return e[0].startsWith("/dev/")?{mount_path:e[2],type:e[4],mount_option:n(e[5])}:null})).filter((function(t){return t})),l.set("mounted_device",a),u=e.data.stdout.split("\n").map((function(t){var e=t.split(/\s+/);return"btrfs"==e[4]||"bcachefs"==e[4]?{mount_path:e[2],type:e[4],mount_option:n(e[5])}:null})).filter((function(t){return t})),console.log("pool info=",u),s=[],i=(0,r.Z)(u),t.prev=11,f=(0,o.Z)().mark((function t(){var e,n,a;return(0,o.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("btrfs"!=(e=d.value).type){t.next=6;break}return t.next=4,g.default.info(e.mount_path);case 4:(n=t.sent)&&(console.log("global_data.pools=",l.pools,"cur=",n),l.pools.filter((function(t){return t.uuid==n.uuid}))[0]||s.push((0,c.Z)((0,c.Z)({},e),n)));case 6:if("bcachefs"!=e.type){t.next=11;break}return t.next=9,w.default.info(e.mount_path);case 9:(a=t.sent)&&(console.log("global_data.pools=",l.pools,"cur=",a),l.pools.filter((function(t){return t.uuid==a.uuid}))[0]||s.push((0,c.Z)((0,c.Z)({},e),a)));case 11:case"end":return t.stop()}}),t)})),i.s();case 14:if((d=i.n()).done){t.next=18;break}return t.delegateYield(f(),"t0",16);case 16:t.next=14;break;case 18:t.next=23;break;case 20:t.prev=20,t.t1=t.catch(11),i.e(t.t1);case 23:return t.prev=23,i.f(),t.finish(23);case 26:console.log("scan_pool_list==",s),_({scan_pool_list:s});case 28:case"end":return t.stop()}}),t,null,[[11,20,23,26]])})));return function(){return t.apply(this,arguments)}}(),j=function(){var t=(0,i.useState)(0),e=(0,u.Z)(t,2),n=e[0],o=e[1],s=[];(0,i.useEffect)((function(){var t=v.watch("scan_pool_list",(function(){n!=l.pools.length+v.scan_pool_list.length&&(n=l.pools.length+v.scan_pool_list.length,o(n))})),e=l.watch("pools",(function(t){n!=t.length+v.scan_pool_list.length&&(n=t.length+v.scan_pool_list.length,o(n))}));return function(){v.unwatch(t),l.unwatch("pools",e)}}),[]),console.log("global_data==",l.pools,v.scan_pool_list);var c,d=[].concat((0,a.Z)(l.pools),(0,a.Z)(v.scan_pool_list)),f=(0,r.Z)(d);try{for(f.s();!(c=f.n()).done;){var p=c.value;if("bcachefs1"===p.type)s.push((0,k.jsx)("div",{children:(0,k.jsx)(w.default.Render,{data:p})},p.uuid));else{var h=D[p.type].Rend;s.push((0,k.jsx)("div",{children:(0,k.jsx)(h,{data:p})},p.uuid))}}}catch(m){f.e(m)}finally{f.f()}return s};return console.log("Render StroageWindow=",Date.now()),(0,k.jsx)(d.default,(0,c.Z)((0,c.Z)({},t),{},{ref:e,children:(0,k.jsxs)("div",{style:{height:"100%"},children:[(0,k.jsx)(f.default,{className:"button success",onClick:Z,children:"\u626b\u63cf"}),(0,k.jsx)(f.default,{className:"button success",onClick:function(){var t="dialog_"+Date.now();m({id:t,content:(0,k.jsx)(N,{id:t})})},children:"\u65b0\u589e"}),(0,k.jsx)(j,{})]})}))}));e.default=T},47425:function(t,e,n){n.r(e),n.d(e,{default:function(){return f}});var a=n(1413),r=n(45987),u=n(29439),o=n(47313),s=(n(1168),n(52794),n(46417)),c=["children","onClick","toggle_ref","shift_ref"],i=window,l=i.Metro,d=i.$;function f(t){var e=(0,o.useState)(0),n=(0,u.Z)(e,2),i=(n[0],n[1],o.createRef()),f=t.children,p=t.onClick,h=t.toggle_ref,m=t.shift_ref,v=(0,r.Z)(t,c);(0,o.useEffect)((function(){l.makePlugin(i.current,"sidebar",(0,a.Z)({shift:m.current,toggle:h.current,menuItemClick:!1},v)).data("sidebar").element.on("click",".sidebar-menu li  > a",(function(t){t.preventDefault();var e=d(t.target);p&&p(e.data("menu"),t)}))}));var x=f.filter((function(t){return"header"==t.props.slot})),_=f.filter((function(t){return"header"!=t.props.slot}));return(0,s.jsxs)("aside",{className:"sidebar pos-absolute z-2",ref:i,children:[x,(0,s.jsxs)("ul",{className:"sidebar-menu",children:[_," "]})]})}}}]);