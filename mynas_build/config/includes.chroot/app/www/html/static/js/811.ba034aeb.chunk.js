"use strict";(self.webpackChunkmypxe_admin=self.webpackChunkmypxe_admin||[]).push([[811],{70811:function(n,t,e){e.r(t);var r=e(29439),c=e(1413),o=e(74165),i=e(15861),a=e(47313),s=e(69393),l=e(63469),u=e(63705),d=(e(47610),e(86385)),p=e(56659),f=e(84724),h=e(37982),x=(e(66109),e(94536)),m=e(46817),_=(e(60786),e(66641),e(60270),e(147),e(70816),e(46417)),v=(h.context_value.global_data,h.context_value.api),w={list:function(){return(0,i.Z)((0,o.Z)().mark((function n(){var t;return(0,o.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,v.run_command({command:"crontab",args:["-l"]});case 2:if(0!=(t=n.sent).ret){n.next=8;break}if(!t.data.stdout.startsWith("no crontab")){n.next=7;break}return n.abrupt("return",{ret:0,data:[]});case 7:return n.abrupt("return",{ret:-2,error:t.data.stdout});case 8:return n.abrupt("return",{ret:-2,error:t});case 9:case"end":return n.stop()}}),n)})))()},reload_cron:function(){return(0,i.Z)((0,o.Z)().mark((function n(){var t;return(0,o.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,v.run_command({command:"crontab",args:["/app/cron/.cron"]});case 2:t=n.sent,console.log("reload_cron ret=",t);case 4:case"end":return n.stop()}}),n)})))()},load_cron:function(){return(0,i.Z)((0,o.Z)().mark((function n(){var t;return(0,o.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,v.config_file({filename:"/app/cron/.cron",op:"get"});case 3:return t=n.sent,n.abrupt("return",w.parse_cron(t));case 7:return n.prev=7,n.t0=n.catch(0),n.abrupt("return",[]);case 10:case"end":return n.stop()}}),n,null,[[0,7]])})))()},save_cron:function(){return(0,i.Z)((0,o.Z)().mark((function n(){var t;return(0,o.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,x.default.mkdir("/app/cron");case 2:return t="",w.cron_list.list.forEach((function(n){t+="".concat(n.cron," \t bash /app/cron/").concat(n.script,"\n")})),n.next=6,v.config_file({op:"put",filename:"/app/cron/.cron",data:t});case 6:return n.sent,n.next=9,w.reload_cron();case 9:case"end":return n.stop()}}),n)})))()},parse_cron:function(n){var t=n.split("\n"),e=[];t.forEach((function(n){var t=n.trim().split(/\s+/);if(t.length>6){var r="",c=0;for(c=0;c<5;c++)r+="".concat(t[c]," ");var o=t[++c];e.push({cron:r,script:o})}})),console.log("set_list===",e),w.cron_list.set("list",e)},CronScriptRemove:function(n){var t=w.cron_list.list,e=t.findIndex((function(t){return t.script==n.filename}));e>=0&&t.splice(e,1),w.save_cron(),x.default.rm(n.filename),w.cron_list.set("list",t)},CronScriptEdit:function(n){var t=n.filename,e=n.data;console.log("CronScriptEdit props=",n);s.WindowApi.windows,s.WindowApi.getApps,s.WindowApi.openWindow,s.WindowApi.set_window_ref;var r=s.WindowApi.openDialog,d=s.WindowApi.closeDialog,p=(0,c.Z)((0,c.Z)({},f.default),{},{$ref:"#/definitions/cron_edit_script"}),h="dialog_"+Date.now(),x=function(){var e=(0,i.Z)((0,o.Z)().mark((function e(r){var c,i,a,s;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.cron,i=r.script,e.next=4,v.config_file({op:"put",filename:"".concat(t),data:i});case 4:e.sent,c!=n.cron&&(a=w.cron_list.list,(s=a.findIndex((function(n){return n.script==t})))>=0&&a.splice(s,1,{cron:c,script:t}),w.save_cron(),w.cron_list.set("list",a)),d(h);case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),g={cron:n.cron,script:e},b=function(){var n=(0,a.useRef)(null);return(0,_.jsxs)(u.default,{width:"fit-content",children:[(0,_.jsx)("div",{type:"title",children:"\u7f16\u8f91\u811a\u672c"}),(0,_.jsx)("div",{type:"content",children:(0,_.jsx)(m.default,{schema:p,ref:n,data:g})}),(0,_.jsx)(l.default,{type:"action",className:"button success",onClick:function(){var t=n.current.getValue();x(t)},children:"\u4fdd\u5b58"}),(0,_.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u5173\u95ed"})]})};r({id:h,content:(0,_.jsx)(b,{id:h})})},CronDialog:function(n){var t=n.title,e=n.data,r=(s.WindowApi.windows,s.WindowApi.getApps,s.WindowApi.openWindow,s.WindowApi.set_window_ref,s.WindowApi.openDialog),d=s.WindowApi.closeDialog,p=(0,c.Z)((0,c.Z)({},f.default),{},{$ref:"#/definitions/cron_add"}),h="dialog_"+Date.now(),x=function(){var n=(0,i.Z)((0,o.Z)().mark((function n(t){var e;return(0,o.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("save_newdata=",t),(e=w.cron_list.list).push({cron:t.cron,script:"/app/cron/".concat(t.script)}),n.next=5,w.save_cron();case 5:w.cron_list.set("list",e),d(h);case 7:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}(),v=function(){var n=(0,a.useRef)(null);return(0,_.jsxs)(u.default,{width:"fit-content",children:[(0,_.jsx)("div",{type:"title",children:t}),(0,_.jsx)("div",{type:"content",children:(0,_.jsx)(m.default,{schema:p,ref:n,data:e})}),(0,_.jsx)(l.default,{type:"action",className:"button success",onClick:function(){var t=n.current.getValue();x(t)},children:"\u4fdd\u5b58"}),(0,_.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u5173\u95ed"})]})};r({id:h,content:(0,_.jsx)(v,{id:h})})},cron_list:(0,h.context_value.make_watch_data)({list:[]}),Render:function(n){0==w.cron_list.list.length&&w.load_cron();var t=function(){var n=(0,a.useState)(0),t=(0,r.Z)(n,2),e=t[0],c=t[1];(0,a.useEffect)((function(){var n=w.cron_list.watch("list",(function(){console.log("change!!!!",e),c(e+1)}));return function(){w.cron_list.unwatch("list",n)}})),console.log("list==",w.cron_list,w.cron_list.get("list"));var o=w.cron_list.list,i=function(n){var t=n.row;return(0,_.jsxs)("div",{className:"dropdown-button",children:[(0,_.jsx)(l.default,{className:"button dropdown-toggle",style:{width:"fit-content"},children:"\u64cd\u4f5c"}),(0,_.jsxs)("ul",{className:"d-menu","data-role":"dropdown",children:[(0,_.jsx)("li",{children:(0,_.jsx)(l.default,{className:"button success",onClick:function(){!function(n){v.config_file({filename:n.script,op:"get"}).then((function(t){w.CronScriptEdit({filename:n.script,data:t,cron:n.cron})})).catch((function(t){w.CronScriptEdit({filename:n.script,data:"#!/bin/bash\n",cron:n.cron})}))}(t)},children:"\u7f16\u8f91"})}),(0,_.jsx)("li",{children:(0,_.jsx)(l.default,{className:"button alert",onClick:function(){!function(n){w.CronScriptRemove({filename:n.script,cron:n.cron})}(t)},children:"\u5220\u9664"})})]})]})};return(0,_.jsxs)(d.default,{data:o,children:[(0,_.jsx)(d.default.TableColumn,{lable:"\u7f16\u8f91",children:(0,_.jsx)(p.default,{"slot-scope":"{row}",children:(0,_.jsx)(i,{})})}),(0,_.jsx)(d.default.TableColumn,{label:"\u5b9a\u65f6\u5668",prop:"cron"}),(0,_.jsx)(d.default.TableColumn,{label:"\u811a\u672c",prop:"script"})]})};return(0,_.jsxs)("div",{style:{height:"100%"},children:[(0,_.jsx)(l.default,{className:"button success",onClick:function(){w.CronDialog({title:"\u6dfb\u52a0\u4efb\u52a1",data:{}})},children:"\u6dfb\u52a0"}),(0,_.jsx)(l.default,{className:"button success",onClick:function(){},children:"\u6dfb\u52a0\u9ed8\u8ba4\u4efb\u52a1"}),(0,_.jsx)(t,{})]})}};t.default=w}}]);