"use strict";(self.webpackChunkmypxe_admin=self.webpackChunkmypxe_admin||[]).push([[548],{5548:function(e,n,t){t.r(n);var o=t(37762),a=t(29439),r=t(74165),i=t(15861),c=t(1413),s=t(47313),u=t(69393),l=t(63469),d=t(63705),f=t(84724),p=t(37982),m=t(66109),v=(t(94536),t(47610)),y=t(46817),h=t(60786),g=(t(66641),t(60270)),w=(t(147),t(46417)),x=p.context_value.global_data,b=p.context_value.api,_={check_ventory:function(){var e=x.get("blockdevices",[]);return e?e.filter((function(e){var n=e.children;if(n&&n.filter((function(e){return"Ventoy"==e.label}))[0])return!0;return!1})):null},ventoy:{ReplaceBoot:function(e){var n=(0,u.useWindowManager)(),t=(n.windows,n.getApps,n.openWindow,n.set_window_ref,n.openDialog,n.closeDialog),o=(0,s.useRef)(null),a=(0,c.Z)((0,c.Z)({},f.default),{},{$ref:"#/definitions/bootconfig"}),l=function(){var n=(0,i.Z)((0,r.Z)().mark((function n(){var a,i,c,s;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=o.current.getValue(),i=e.conf_replace,c={},!i.new){n.next=9;break}return n.next=6,b.config_file({filename:"/tmp/ventoy".concat(i.new),op:"put",data:a});case 6:return n.sent,t(e.id),n.abrupt("return");case 9:return(s=e.ventoy_config).conf_replace||(s.conf_replace=[]),n.next=13,b.run_command({command:"mkdir",args:["-p","/tmp/ventoy/data"]});case 13:return c.new="/data/live_mynas.cfg",c.org="/isolinux/live.cfg",c.iso=i.iso,n.next=18,b.config_file({filename:"/tmp/ventoy".concat(c.new),op:"put",data:a});case 18:return s.conf_replace.push(c),n.next=21,b.config_file({filename:"/tmp/ventoy/ventoy/ventoy.json",op:"put",data:JSON.stringify(s)});case 21:t(e.id);case 22:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return(0,w.jsxs)(d.default,{id:e.id,children:[(0,w.jsx)("div",{type:"title"}),(0,w.jsx)("div",{type:"content",children:(0,w.jsx)(y.default,{schema:a,ref:o,data:e.data,style:{width:"100vh",height:"100%"}})}),(0,w.jsx)("button",{type:"action",className:"button warning",onClick:l,children:"\u786e\u5b9a"}),(0,w.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u53d6\u6d88"})]})},ConfigVentoy:function(e){var n=(0,u.useWindowManager)(),t=(n.windows,n.getApps,n.openWindow,n.set_window_ref,n.openDialog,n.closeDialog),o=(0,s.useRef)(null),l=(0,s.useState)(0),p=(0,a.Z)(l,2),m=(p[0],p[1],(0,c.Z)((0,c.Z)({},f.default),{},{$ref:"#/definitions/ventoy"})),v=function(){var n=(0,i.Z)((0,r.Z)().mark((function n(){var a,i;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:a=o.current.getValue(),(i=JSON.parse(a))&&(r=i,b.config_file({filename:"/tmp/ventoy/ventoy/ventoy.json",op:"put",data:JSON.stringify(r)}).then((function(n){0==n.ret&&t(e.id)})));case 3:case"end":return n.stop()}var r}),n)})));return function(){return n.apply(this,arguments)}}();return(0,w.jsxs)(d.default,{id:e.id,children:[(0,w.jsx)("div",{type:"title"}),(0,w.jsx)("div",{type:"content",children:(0,w.jsx)(y.default,{schema:m,ref:o,data:e.data,style:{width:"100vh",height:"100%"}})}),(0,w.jsx)("button",{type:"action",className:"button warning",onClick:v,children:"\u786e\u5b9a"}),(0,w.jsx)("button",{type:"action",className:"button js-dialog-close",children:"\u53d6\u6d88"})]})}},download:function(e,n){b.download_file({filename:e,op:"get"}).then((function(e){console.log("resp==",e);var t=n,o=new Blob([e.data],{type:e.headers["content-type"]});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(o,t);else{var a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}}))},BackupDialog:function(e){var n=(0,s.useRef)(null),t=(0,s.useRef)(null),o=(0,s.useState)(""),r=(0,a.Z)(o,2);r[0],r[1];return(0,s.useEffect)((function(){setTimeout((function(){n.current=new h.Terminal({rows:40,convertEol:!0,scrollback:10,disableStdin:!1,cursorStyle:"underline",cursorBlink:!0});var o=new g.FitAddon;n.current.loadAddon(o),n.current.onResize((function(e){o.fit()})),n.current.open(t.current),m.default.long_cmd({command:"7zr",args:["a","-t7z","/tmp/backup.7z","/etc/","/app/"]},{stdout:function(e){n.current&&n.current.write(e)},onend:function(){e.onEnd&&e.onEnd()}})}),100)})),(0,w.jsxs)(d.default,{children:[(0,w.jsx)("div",{type:"title",children:"\u538b\u7f29\u4e2d"}),(0,w.jsx)("div",{type:"content",ref:t,width:"100%",height:"100%"})]})},VentoySetting:function(e){var n=(0,u.useWindowManager)(),t=(n.windows,n.getApps,n.openWindow,n.set_window_ref,n.openDialog),o=e.data.children.filter((function(e){return"Ventoy"==e.label}))[0];if(o.children&&o.children.length>0){var d=o.children.filter((function(e){return 0==e.ro&&"dm"==e.type}))[0];d&&(o=d)}var f=(0,p.rix_make_watch_data)((0,c.Z)((0,c.Z)({},o),{},{mounted:!1})),m=function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.run_command({command:"bash",args:["-c","mount | grep /tmp/ventoy"]});case 2:""==e.sent.data.stdout?f.set("mounted",!1):f.set("mounted",!0);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,s.useEffect)((function(){m()}));var y=function(){var e=function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.run_command({command:"mkdir",args:["-p","/tmp/ventoy"]});case 2:return f.path.split("/").pop(),console.log("use====",f),e.next=6,b.run_command({command:"mount",args:["".concat(f.path),"/tmp/ventoy"]});case 6:e.sent,m();case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),n=function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.run_command({command:"umount",args:["/tmp/ventoy"]});case 2:e.sent,m();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t=(0,s.useState)(0),o=(0,a.Z)(t,2),c=o[0],u=o[1];return(0,s.useEffect)((function(){f.watch("mounted",(function(){u(c+1)}));return function(){f.unwatch("mounted")}})),f.mounted?(0,w.jsx)(l.default,{className:"button success",onClick:n,children:"\u5378\u8f7d"}):(0,w.jsx)(l.default,{className:"button success",onClick:e,children:"\u4f7f\u7528"})},h=function(){var e=(0,s.useState)(0),n=(0,a.Z)(e,2),o=n[0],c=n[1];(0,s.useEffect)((function(){f.watch("mounted",(function(){c(o+1)}));return function(){f.unwatch("mounted")}}));var u=function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){var n,o,a,i,c,s,u;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.config_file({filename:"/tmp/ventoy/ventoy/ventoy.json",op:"get"});case 2:if(n=e.sent,o={},n&&n.conf_replace&&(a=n.conf_replace.filter((function(e){return!!e.iso.endsWith("mynas-image-amd64.hybrid.iso")}))[0])&&(o=a),o.iso){e.next=10;break}return e.next=8,b.run_command({command:"find",args:["/tmp/ventoy -type f -name mynas-image-amd64.hybrid.iso"]});case 8:0==(i=e.sent).ret&&""!=i.data.stdout&&(o.iso=i.data.stdout);case 10:if(console.log("conf_replace==",o),o.iso){e.next=13;break}return e.abrupt("return");case 13:if(c="\nlabel live-rix-with-persistence-encryption\n        menu label ^Live system (rix) without persistence-encryption\n        linux /live/vmlinuz\n        initrd /live/initrd.img\n        append boot=live components persistence persistence-encryption=luks persistence-label=mynas quiet splash pci=noaer pcie_aspm=off ip=frommedia\nlabel live-rix\n        menu label ^Live system (rix)\n        menu default\n        linux /live/vmlinuz\n        initrd /live/initrd.img\n        append boot=live components persistence persistence-label=mynas quiet splash pci=noaer pcie_aspm=off ip=frommedia\n\nlabel live-rix-failsafe\n        menu label Live system (rix fail-safe mode)\n        linux /live/vmlinuz\n        initrd /live/initrd.img\n        append boot=live components memtest noapic noapm nodma nomce nolapic nosmp nosplash vga=788\n",!o.new){e.next=19;break}return e.next=17,b.config_file({filename:"/tmp/ventoy/ventoy/ventoy.json",op:"get"});case 17:(s=e.sent)&&!s.ret&&(c=s);case 19:u="dialog_"+Date.now(),t({id:u,content:(0,w.jsx)(_.ventoy.ReplaceBoot,{id:u,data:c,conf_replace:o,ventoy_config:n})});case 21:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return f.mounted?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(l.default,{className:"button success",children:"\u521b\u5efapersestenc\u955c\u50cf"}),(0,w.jsx)(l.default,{className:"button success",children:"\u914d\u7f6e\u6302\u8f7dpersestenc\u955c\u50cf"}),(0,w.jsx)(l.default,{className:"button success",onClick:u,children:"\u914d\u7f6e\u542f\u52a8\u6587\u4ef6"}),(0,w.jsx)(l.default,{className:"button success",onClick:function(){var e=function(){var e=(0,i.Z)((0,r.Z)().mark((function e(){var n,o,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.config_file({filename:"/tmp/ventoy/ventoy/ventoy.json",op:"get"});case 2:n=e.sent;try{n&&!n.ret&&(console.log("update config==",n),o=JSON.stringify(n,null,2),a="dialog_"+Date.now(),t({id:a,content:(0,w.jsx)(_.ventoy.ConfigVentoy,{id:a,data:o})}))}catch(r){}case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()},children:"\u914d\u7f6eventoy"})]}):(0,w.jsx)(w.Fragment,{children:"\u5148\u6302\u8f7d\u624d\u80fd\u914d\u7f6e"})};return(0,w.jsxs)(v.default,{collapsible:!0,children:[(0,w.jsxs)("div",{type:"title",children:["ventory\u914d\u7f6e \u8bbe\u5907:",e.data.path," \u5927\u5c0f:",e.data.size]}),(0,w.jsx)(y,{type:"button"}),(0,w.jsx)("div",{className:"w-100",style:{display:"flex",justifyContent:"space-around"},children:(0,w.jsx)(h,{})})]})},Setting:function(){var e=(0,u.useWindowManager)(),n=(e.windows,e.getApps,e.openWindow,e.set_window_ref,e.openDialog),t=(0,p.rix_make_watch_data)({ventoy:[]});(0,s.useEffect)((function(){var e=_.check_ventory();t.set("ventoy",e);x.watch("blockdevices",(function(){var e=_.check_ventory();t.set("ventoy",e)}));return function(){x.unwatch("blockdevices")}}));var r=function(){var e=(0,s.useState)(0),n=(0,a.Z)(e,2),r=n[0],i=n[1];(0,s.useEffect)((function(){var e=t.watch("ventoy",(function(){i(r+1)}));return function(){t.unwatch(e)}}));var c,u=[],l=(0,o.Z)(t.ventoy);try{for(l.s();!(c=l.n()).done;){var d=c.value;u.push((0,w.jsx)(s.Fragment,{children:(0,w.jsx)(_.VentoySetting,{data:d})},d.path))}}catch(f){l.e(f)}finally{l.f()}return u};return(0,w.jsxs)("div",{children:["\u5907\u4efd\u670d\u52a1\u5668\u914d\u7f6e",(0,w.jsx)(l.default,{className:"button success",onClick:function(){var e="dialog_"+Date.now();n({id:e,content:(0,w.jsx)(_.BackupDialog,{onEnd:function(){_.download("/tmp/backup.7z","backup.7z")}})})},children:"\u5907\u4efd"}),(0,w.jsx)(r,{})]})}};n.default=_}}]);